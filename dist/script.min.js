function OrderCloudSDKBuyerXP(e){e.decorator("OrderCloudSDK",["$delegate","bachBuyerXp","$q",function(e,r,t){return e.Buyers.Get=function(){var t=e.GetToken();return r.Get(t)},e.Buyers.List=function(){return e.Buyers.Get().then(function(e){return{Items:[e],Meta:{Page:1,PageSize:1,TotalPages:1,TotalCount:1,ItemRange:[1,1]}}})},e.Buyers.Update=function(){var n=[].slice.call(arguments)[1],i=e.GetToken();return n&&n.xp?r.Update(i,n.xp):t.reject("Missing body")},e.Buyers.Patch=function(){var n=[].slice.call(arguments)[1],i=e.GetToken();return n?r.Patch(i,n):t.reject("Missing body")},e}])}function bachAssignments(e,r,t){function n(n){return r(e+"/assignments/usergroup",{},{call:{method:"POST",headers:{"oc-token":t.GetToken()}}}).call(n).$promise}var i={UserGroup:n};return i}function bachBuyerXpService(e,r,t,n){function i(n){function i(){var e=t(function(){u&&(t.cancel(e),o.resolve(u))},100)}var o=e.defer();return u?o.resolve(u):s?i():(s=!0,r.get(c,{headers:{"oc-token":n}}).then(function(e){u={xp:e.data},o.resolve(u)}).catch(function(e){o.reject(e)})),o.promise}function o(e,t){return r.put(c,t,{headers:{"oc-token":e}})}function a(e,t){return r.patch(c,e,{headers:{"oc-token":t}})}var c=n+"/buyerxp",u=null,s=!1,d={Get:i,Update:o,Patch:a};return d}function bachGiftCards(e,r,t,n,i){function o(e){return d().create(e).$promise}function a(e){return e.body||e.body.id?d().update({id:e.body.id},e.body).$promise:t.error("id is a required parameter")}function c(e){return d().delete({id:e.id}).$promise}function u(e){return d().list(e&&e.searchTerm?{searchTerm:e.searchTerm}:null).$promise.then(function(e){return e.list})}function s(r){return n.post(e+"/giftcards/purchase/"+r.orderid,{},{headers:{"oc-token":i.GetToken()}})}function d(){var t={create:{method:"POST"},update:{method:"PUT"},"delete":{method:"DELETE"},list:{method:"GET"}};return _.each(t,function(e){e.headers={"oc-token":i.GetToken()}}),r(e+"/giftcards/:id",{},t)}var p={Create:o,Update:a,Delete:c,List:u,Purchase:s};return p}function bachShipmentsService(e,r,t,n,i,o){function a(e,r){y=r;var t=_.groupBy(e,function(e){var r="",t="";e.ShippingAddress&&(r=(e.ShippingAddress.FirstName+e.ShippingAddress.LastName).replace(/ /g,"").toLowerCase(),t=_.values(_.pick(e.ShippingAddress,"Street1","Street2","City","State","Zip","Country")).join("").replace(/ /g,"").toLowerCase());var n=e.xp.DeliveryDate||"",i=e.xp.Destination&&_.contains(["T","F","E"],e.xp.Destination),o=e.xp.DeliveryMethod||"",a=e.xp.Status||"Open";return r+t+n+o+a+i});return c(_.values(t))}function c(e){var r=[];return _.each(e,function(e){var t=_.filter(e,function(e){return _.some(e.xp,{DeliveryMethod:"InStorePickup"})}),n=_.groupBy(e,function(e){return t?e.xp.ProductFromStore:void 0});_.each(n,function(e){r.push(e)})}),u(r)}function u(e){return _.each(e,function(r,t){_.each(r,function(n,i){if(n.Product.xp.isEvent&&r.length>1){var o=e[t].splice(i,1);e.push(o)}})}),s(e)}function s(e){var r=[];return _.each(e,function(e){n.DetermineEithers(e,y);var t=_.groupBy(e,function(e){return e.xp.Destination});_.each(t,function(e){r.push(e)})}),d(r)}function d(e){var r=_.findWhere(y.wireOrder.OutgoingOrders,{Name:"FTD.com"}),t=_.findWhere(y.wireOrder.OutgoingOrders,{Name:"Teleflora.com"});return _.each(e,function(e){e.Cost=0,e.Tax=0,e.FTDServiceFees=0,e.FTDDeliveryFees=0,e.TFEServiceFees=0,e.TFEDeliveryFees=0,_.each(e,function(r){r.xp&&(r.xp.Tax=r.xp.Tax||0,e.Cost=T(e.Cost,r.LineTotal),e.Tax=T(e.Tax,r.xp.Tax))}),e[0].xp.Destination&&"F"===e[0].xp.Destination&&(e.FTDServiceFees=T(r.WiredServiceFees,e.FTDServiceFees),e.FTDDeliveryFees=T(r.WiredDeliveryFees,e.FTDDeliveryFees)),e[0].xp.Destination&&"T"===e[0].xp.Destination&&(e.TFEServiceFees=T(t.WiredServiceFees,e.TFEServiceFees),e.TFEDeliveryFees=T(t.WiredDeliveryFees,e.TFEDeliveryFees)),e.Total=T(e.Cost,e.Tax)}),e}function p(t,n,i){var o=a(t,i),c=[];return _.each(o,function(e,t){var i=[];_.each(e,function(e){i.push({OrderID:n.ID,LineItemID:e.ID,QuantityShipped:e.Quantity})});var o=t+1,a=e[0],u={BuyerID:r,ID:n.ID+"-"+(10>o?"0":"")+o,DateDelivered:null,Cost:e.Cost,Items:i,xp:{Status:v(a),PrintStatus:F(a),Direction:"Outgoing",DeliveryMethod:m(a),RequestedDeliveryDate:D(a.xp.DeliveryDate),addressType:a.xp.addressType,RecipientName:a.ShippingAddress.FirstName+" "+a.ShippingAddress.LastName,Tax:e.Tax,DeliveryCharges:"",RouteCode:a.xp.RouteCode,TimePreference:a.xp.deliveryRun||"NO PREF",ShipTo:a.ShippingAddress}};c.push(h(n.ID,u))}),e.all(c)}function h(e,r){var n={orderID:e,Shipment:r};return i(o+"/shipments/create",{},{call:{method:"POST",headers:{"oc-token":t.GetToken()}}}).call(n).$promise}function l(r){var n={},i={pageSize:100,orderID:r};return t.Shipments.List(i).then(function(r){var i=[];return _.each(r.Items,function(e){i.push(function(){return t.Shipments.ListItems(e.ID).then(function(r){return e.Items=r.Items,_.each(r.Items,function(e){n[e.LineItemID]=e}),e})}())}),e.all(i).then(function(e){return _.each(e,function(r,t){_.each(r.Items,function(r,i){_.each(r.xp.AddExtraLineItemsList,function(r,o){e[t].Items[i].xp.AddExtraLineItemsList[o]=n[r]})})}),e})})}function f(e,r){var n=0,i=0,o=0;return _.each(r,function(e){e.FTDDeliveryFees&&e.FTDDeliveryFees>0&&(n=T(n,e.FTDDeliveryFees)),e.FTDServiceFees&&e.FTDServiceFees>0&&(n=T(n,e.FTDServiceFees)),e.TFEDeliveryFees&&e.TFEDeliveryFees>0&&(n=T(n,e.TFEDeliveryFees)),e.TFEServiceFees&&e.TFEServiceFees>0&&(n=T(n,e.TFEServiceFees))}),t.LineItems.List("outgoing",e).then(function(r){return _.each(r.Items,function(e){i=T(i,e.xp.deliveryCharges||0),o=T(o,e.xp.Tax)}),t.Orders.Patch("outgoing",e,{ShippingCost:n||i,TaxCost:o,xp:{Tax:o.toFixed(2)}})})}function v(e){return e.xp.Destination&&_.contains(["F","T"],e.xp.Destination)?"OnHold":e.xp.Status&&"OnHold"===e.xp.Status?"OnHold":e.xp.addressType&&_.contains(["Funeral","Church","Cemetary"],e.xp.addressType)?"OnHold":"New"}function D(e){var r=new Date(e);return(r.getMonth()+1<10?"0"+(r.getMonth()+1):r.getMonth()+1)+"/"+(r.getDate()<10?"0"+r.getDate():r.getDate())+"/"+r.getFullYear()}function F(e){return"LocalDelivery"===e.xp.DeliveryMethod||"InStorePickup"===e.xp.DeliveryMethod&&"OtherStore"===e.xp.ProductFromStore?"NotPrinted":"NotNeeded"}function m(e){return e.xp&&e.xp.Destination&&_.contains(["F","T"],e.xp.Destination)?"F"===e.xp.Destination?"FTD":"TFE":e.xp.DeliveryMethod}function T(){return _.reduce(arguments,function(e,r){return(100*e+100*r)/100},0)}var y={},g={Group:a,Create:p,List:l,CalculateShippingCost:f};return g}function bachWiredOrdersService(e){function r(e){var r=0;return _.each(e,function(e){e.FTDDeliveryFees&&e.FTDDeliveryFees>0&&(r=s(r,e.FTDDeliveryFees)),e.TFEDeliveryFees&&e.TFEDeliveryFees>0&&(r=s(r,e.TFEDeliveryFees))}),r}function t(e){var r=0;return _.each(e,function(e){e.FTDServiceFees&&e.FTDServiceFees>0&&(r=s(r,e.FTDServiceFees)),e.TFEServiceFees&&e.TFEServiceFees>0&&(r=s(r,e.TFEServiceFees))}),r}function n(e,r){var t=i(e),n=_.groupBy(t,function(e){return e.xp.Destination});if(n.E&&n.E.length>0){var s=_.findWhere(r.wireOrder.OutgoingOrders,{Name:"FTD.com"}),d=_.findWhere(r.wireOrder.OutgoingOrders,{Name:"Teleflora.com"});s.type="F",d.type="T";var p,h=_.without(_.keys(n),"E");if(0===h.length){var l=_.groupBy(e,function(e){return e.xp.Destination}),f="undefined"!=typeof l.F,v="undefined"!=typeof l.T;if(f&&!v)return a(e,"F");if(!f&&v)return a(e,"T");if(f&&v){var D=l.F.length,F=l.T.length;return D!==F?a(e,D>F?"F":"T"):(p=o(s.OrderPercentage,d.OrderPercentage),a(e,p))}return p=o(s.OrderPercentage,d.OrderPercentage),a(e,p)}if(1===h.length)return p=h[0],a(e,p);var m=s.OrderPercentage>d.OrderPercentage?s:d,T="F"===m.type?d:s,y=c(n.E),g=c(n[m.type]),x=c(n[T.type]);return y+g>=m.MinOrderPrice.Price?u(n.E,g,m).then(function(e){var r=c(e);return r+x>=T.MinOrderPrice.Price?u(e,x,T).then(function(e){_.each(e,function(e){return p=o(s.OrderPercentage,d.OrderPercentage),a([e],p)})}):(p=m.type,a(e,p))}):y+x>=T.MinOrderPrice.Price?(p=T.type,a(n.E,T.type)):(p=m.type,a(n.E,m.type))}}function i(e){return e=angular.copy(e),_.each(e,function(e){var r=["F","T","E"];r.indexOf(e.Product.xp.CodeB4)>-1&&"Y"===e.Product.xp.CodeB2&&"LocalDelivery"!==e.xp.DeliveryMethod?(e.xp.deliveryCharges=0,"F"===e.Product.xp.CodeB4&&(e.xp.Destination="FTD"),"T"===e.Product.xp.CodeB4&&(e.xp.Destination="TFE"),"E"===e.Product.xp.CodeB4&&(e.xp.Destination="E"),e.xp.Status="OnHold"):e.xp.Destination&&delete e.xp.Destination}),e}function o(e,r){var t,n=100*Math.random();return t=e&&r?r>e?n>=0&&e>=n?"F":"T":n>=0&&r>=n?"T":"F":!e&&r?"T":!r&&e?"F":n>50?"F":"T"}function a(e,r){_.each(e,function(e){e.xp.Destination=r,e.xp.Status="OnHold"})}function c(e){var r=_.pluck(e,"LineTotal");return _.reduce(r,function(e,r){return e+r},0)}function u(r,t,n){if(t>=n.MinOrderPrice.Price)return e.when(r);var i=r.shift();return t+=i,a([i],n.type),u(r,t,n.MinOrderPrice.Price)}function s(e,r){return(100*e+100*r)/100}var d={GetDeliveryFees:r,GetServiceFees:t,GetDestinations:i,DetermineEithers:n};return d}angular.module("bachmans-common",[]),OrderCloudSDKBuyerXP.$inject=["$provide"],angular.module("bachmans-common").config(OrderCloudSDKBuyerXP),bachAssignments.$inject=["nodeapiurl","$resource","OrderCloudSDK"],angular.module("bachmans-common").factory("bachAssignments",bachAssignments),bachBuyerXpService.$inject=["$q","$http","$interval","nodeapiurl"],angular.module("bachmans-common").factory("bachBuyerXp",bachBuyerXpService),bachGiftCards.$inject=["nodeapiurl","$resource","toastr","$http","OrderCloudSDK"],angular.module("bachmans-common").factory("bachGiftCards",bachGiftCards),bachShipmentsService.$inject=["$q","buyerid","OrderCloudSDK","bachWiredOrders","$resource","nodeapiurl"],angular.module("bachmans-common").factory("bachShipments",bachShipmentsService),bachWiredOrdersService.$inject=["$q"],angular.module("bachmans-common").factory("bachWiredOrders",bachWiredOrdersService);