function OrderCloudSDKBuyerXP(e){e.decorator("OrderCloudSDK",["$delegate","bachBuyerXp","$q",function(e,t,r){return e.Buyers.Get=function(){var r=e.GetToken();return t.Get(r)},e.Buyers.List=function(){return e.Buyers.Get().then(function(e){return{Items:[e],Meta:{Page:1,PageSize:1,TotalPages:1,TotalCount:1,ItemRange:[1,1]}}})},e.Buyers.Update=function(){var n=[].slice.call(arguments)[1],i=e.GetToken();return n&&n.xp?t.Update(i,n.xp):r.reject("Missing body")},e.Buyers.Patch=function(){var n=[].slice.call(arguments)[1],i=e.GetToken();return n?t.Patch(i,n):r.reject("Missing body")},e}])}function lineItemThrottleDecorator(e){e.decorator("OrderCloudSDK",["$delegate","$q","$timeout",function(e,t,r){function n(){return v=!1,d.apply(e,arguments)}function i(){return v=!1,p.apply(e,arguments)}function a(){return v=!1,l.apply(e,arguments)}function o(){return v=!1,h.apply(e,arguments)}function c(){function n(){v=!0,f=!1,i()}function i(){r(function(){v=!1},3e3)}function a(){r(function(){f?a():o()},100)}function o(){m?c.reject(u):c.resolve(u)}var c=t.defer();return f?a():v?o():(f=!0,s.apply(e,arguments).then(function(e){u=e,m=!1,n(),o()}).catch(function(){m=!0,n(),o()})),c.promise}var u,s=e.LineItems.List,d=e.LineItems.Delete,p=e.LineItems.Update,l=e.LineItems.Patch,h=e.LineItems.Create,m=!1,f=!1,v=!1;return e.LineItems.List=c,e.LineItems.Delete=n,e.LineItems.Update=i,e.LineItems.Patch=a,e.LineItems.Create=o,e}])}function bachAssignments(e,t,r){function n(n){return t(e+"/assignments/usergroup",{},{call:{method:"POST",headers:{"oc-token":r.GetToken()}}}).call(n).$promise}var i={UserGroup:n};return i}function bachBuyerXpService(e,t,r,n){function i(n){function i(){var e=r(function(){s&&(r.cancel(e),a.resolve(s))},100)}var a=e.defer();return s?a.resolve(s):d?i():(d=!0,t.get(u,{headers:{"oc-token":n}}).then(function(e){s={xp:e.data},a.resolve(s)}).catch(function(e){a.reject(e)})),a.promise}function a(){return s}function o(e,r){return t.put(u,r,{headers:{"oc-token":e}}).then(function(e){return s={xp:e.data}})}function c(e,r){return t.patch(u,e,{headers:{"oc-token":r}}).then(function(e){return s={xp:e.data}})}var u=n+"/buyerxp",s=null,d=!1,p={Get:i,GetCache:a,Update:o,Patch:c};return p}function bachGiftCards(e,t,r,n,i){function a(e){return d().create(e).$promise}function o(e){return e.body||e.body.id?d().update({id:e.body.id},e.body).$promise:r.error("id is a required parameter")}function c(e){return d().delete({id:e.id}).$promise}function u(e){return d().list(e&&e.searchTerm?{searchTerm:e.searchTerm}:null).$promise.then(function(e){return e.list})}function s(t){return n.post(e+"/giftcards/purchase/"+t.orderid,{},{headers:{"oc-token":i.GetToken()}})}function d(){var r={create:{method:"POST"},update:{method:"PUT"},"delete":{method:"DELETE"},list:{method:"GET"}};return _.each(r,function(e){e.headers={"oc-token":i.GetToken()}}),t(e+"/giftcards/:id",{},r)}var p={Create:a,Update:o,Delete:c,List:u,Purchase:s};return p}function bachShipmentsService(e,t,r,n,i,a,o,c){function u(e){var t=_.groupBy(e,function(e){var t="",r="";e.ShippingAddress&&(t=(e.ShippingAddress.FirstName+e.ShippingAddress.LastName).replace(/ /g,"").toLowerCase(),r=_.values(_.pick(e.ShippingAddress,"Street1","Street2","City","State","Zip","Country")).join("").replace(/ /g,"").toLowerCase());var n=e.xp.DeliveryDate||"",i=e.xp.Destination&&_.contains(["T","F","E"],e.xp.Destination),a=e.xp.DeliveryMethod||"",o=e.xp.Status||"Open";return t+r+n+a+o+i});return s(_.values(t))}function s(e){var t=[];return _.each(e,function(e){var r=_.filter(e,function(e){return _.some(e.xp,{DeliveryMethod:"InStorePickup"})}),n=_.groupBy(e,function(e){return r?e.xp.ProductFromStore:void 0});_.each(n,function(e){t.push(e)})}),d(t)}function d(e){return _.each(e,function(t,r){_.each(t,function(n,i){if(n.Product.xp.isEvent&&t.length>1){var a=e[r].splice(i,1);e.push(a)}})}),p(e)}function p(e){var t=[];return _.each(e,function(e){var r=i.GetCache().xp.wireOrder.OutgoingOrders;n.DetermineEithers(e,r);var a=_.groupBy(e,function(e){return e.xp.Destination});_.each(a,function(n,i){var a="F"===i||"T"===i;a&&_.each(n,function(t){_.each(t.xp.deliveryFeesDtls,function(e,r){var n=["LocalDelivery","Standard Delivery","InStorePickUp","Courier","USPS","UPS Charges","Event"];_.contains(n,r)&&(t.xp.deliveryFeesDtls[r]=0),_.contains(["Wired Delivery Charges"],["Wired Service Charges"])&&(t.xp.deliveryFeesDtls[r]=0)}),e[0].xp.deliveryFeesDtls||(e[0].xp.deliveryFeesDtls={}),e[0].xp.deliveryFeesDtls["Wired Delivery Charges"]=Number(r.WiredDeliveryFees),e[0].xp.deliveryFeesDtls["Wired Service Charges"]=Number(r.WiredServiceFees)}),t.push(n)})}),l(t)}function l(e){return _.each(e,function(e){e.Cost=0,e.Tax=0,e.deliveryFeesDtls={};var t=0,r=0,n=0;_.each(e,function(i){i.xp&&(i.xp.Tax=i.xp.Tax||0,e.Cost=S(e.Cost,i.LineTotal),e.Tax=S(e.Tax,i.xp.Tax)),_.each(i.xp.deliveryFeesDtls,function(i,a){_.contains(["LocalDelivery","Standard Delivery","InStorePickUp","Courier","USPS","UPS Charges","Event"],a)?t=S(t,i):_.contains(["Wired Delivery Charges","Wired Service Charges"],a)?r=S(r,i):n=S(n,i),e.deliveryFeesDtls[a]=e.deliveryFeesDtls[a]?S(e.deliveryFeesDtls[a],i):i})}),e.DeliveryCharges=n+(r||t),e.Total=S(e.Cost,e.Tax,e.DeliveryCharges)}),e}function h(e,t){var n=u(e),i=_.flatten(n);return _.each(i,function(e){("F"===e.xp.Destination||"T"===e.xp.Destination)&&r.LineItems.Patch(T?"outgoing":"incoming",t,e.ID,{xp:{deliveryFeesDtls:e.xp.deliveryFeesDtls}})}),n}function m(r,n){var i=h(r),a=[];return _.each(i,function(e,r){var i=[];_.each(e,function(e){i.push({OrderID:n.ID,LineItemID:e.ID,QuantityShipped:e.Quantity})});var o=r+1,c=e[0],u="anon-template-user"===n.FromUserID,s={BuyerID:t,ID:n.ID+"-"+(10>o?"0":"")+o,DateDelivered:null,Cost:e.Cost,Items:i,xp:{Status:D(c),PrintStatus:g(c),Direction:"Outgoing",DeliveryMethod:x(c),DateSubmitted:y(n.DateSubmitted),RequestedDeliveryDate:y(c.xp.DeliveryDate),addressType:c.xp.addressType,RecipientName:c.ShippingAddress.FirstName+" "+c.ShippingAddress.LastName,SenderName:u?n.BillingAddress.FirstName+" "+n.BillingAddress.LastName:n.FromUser.FirstName+" "+n.FromUser.LastName,FromUserID:n.FromUserID,CSRID:n.xp.CSRID||"Web",Tax:e.Tax,DeliveryCharges:e.DeliveryCharges,RouteCode:c.xp.RouteCode,TimePreference:c.xp.deliveryRun||"NO PREF",ShipTo:c.ShippingAddress}};a.push(f(n.ID,s))}),e.all(a)}function f(e,t){var n={orderID:e,Shipment:t};return a(o+"/shipments/create",{},{call:{method:"POST",headers:{"oc-token":r.GetToken()}}}).call(n).$promise}function v(t){var n={},i={pageSize:100,orderID:t};return r.Shipments.List(i).then(function(t){var i=[];return _.each(t.Items,function(e){i.push(function(){return r.Shipments.ListItems(e.ID).then(function(t){return e.Items=t.Items,_.each(t.Items,function(e){n[e.LineItemID]=e}),e})}())}),e.all(i).then(function(e){return _.each(e,function(t,r){_.each(t.Items,function(t,i){_.each(t.xp.AddExtraLineItemsList,function(t,a){e[r].Items[i].xp.AddExtraLineItemsList[a]=n[t]})})}),e})})}function D(e){return e.xp.Destination&&_.contains(["F","T"],e.xp.Destination)?"OnHold":e.xp.Status&&"OnHold"===e.xp.Status?"OnHold":e.xp.addressType&&_.contains(["Funeral","Church","Cemetary"],e.xp.addressType)?"OnHold":"New"}function y(e){if(e){var t=new Date(e);return t.getFullYear()+"-"+t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1+"-"+(t.getDate()<10?"0"+t.getDate():t.getDate())}return"N/A"}function g(e){return"LocalDelivery"===e.xp.DeliveryMethod||"InStorePickup"===e.xp.DeliveryMethod&&"OtherStore"===e.xp.ProductFromStore?"NotPrinted":"NotNeeded"}function x(e){return e.xp&&e.xp.Destination&&_.contains(["F","T"],e.xp.Destination)?"F"===e.xp.Destination?"FTD":"TFE":e.xp.DeliveryMethod}function S(){return _.reduce(arguments,function(e,t){return(100*e+100*t)/100},0)}var T="BachmanStoreFront"===c,C={Group:u,GroupAndPatchLIs:h,Create:m,List:v};return C}function bachWiredOrdersService(e){function t(e,t){var c=r(e),u=_.groupBy(c,function(e){return e.xp.Destination});if(u.E&&u.E.length>0){var s,d=_.findWhere(t.Destinations,{Name:"FTD.com"}),p=_.findWhere(t.Destinations,{Name:"Teleflora.com"}),l=_.without(_.keys(u),"E");if(0===l.length)return s=n(d.OrderPercentage,p.OrderPercentage),i(e,s);if(1===l.length)return s=l[0],i(e,s);var h=d.OrderPercentage>p.OrderPercentage?d:p,m="F"===h.Type?p:d,f=a(u.E),v=a(u[h.Type]),D=a(u[m.Type]);return f+v>=h.MinOrderPrice?o(u.E,v,h).then(function(e){var t=a(e);return t+D>=m.MinOrderPrice?o(e,D,m).then(function(e){_.each(e,function(e){return s=n(d.OrderPercentage,p.OrderPercentage),i([e],s)})}):(s=h.Type,i(e,s))}):f+D>=m.MinOrderPrice?o(u.E,D,m).then(function(e){return e?(s=m.Type,i(e,s)):void 0}):(s=n(d.OrderPercentage,p.OrderPercentage),i(u.E,h.Type))}}function r(e){return e=angular.copy(e),_.each(e,function(e){var t=["F","T","E"];_.contains(t,e.Product.xp.CodeB4)&&"Y"===e.Product.xp.CodeB2&&"LocalDelivery"!==e.xp.DeliveryMethod?(e.xp.deliveryCharges=0,"F"===e.Product.xp.CodeB4&&(e.xp.Destination="FTD"),"T"===e.Product.xp.CodeB4&&(e.xp.Destination="TFE"),"E"===e.Product.xp.CodeB4&&(e.xp.Destination="E"),e.xp.Status="OnHold"):e.xp.Destination&&delete e.xp.Destination}),e}function n(e,t){var r,n=100*Math.random();return r=e&&t?t>e?n>=0&&e>=n?"F":"T":n>=0&&t>=n?"T":"F":!e&&t?"T":!t&&e?"F":n>50?"F":"T"}function i(e,t){_.each(e,function(e){e.xp.Destination=t})}function a(e){var t=_.pluck(e,"LineTotal");return _.reduce(t,function(e,t){return e+t},0)}function o(t,r,n){if(r>=n.MinOrderPrice)return e.when(t);var a=t.shift();return r+=a,i([a],n.Type),o(t,r,n.MinOrderPrice)}var c={DetermineEithers:t};return c}angular.module("bachmans-common",[]),OrderCloudSDKBuyerXP.$inject=["$provide"],angular.module("bachmans-common").config(OrderCloudSDKBuyerXP),lineItemThrottleDecorator.$inject=["$provide"],angular.module("bachmans-common").config(lineItemThrottleDecorator),bachAssignments.$inject=["nodeapiurl","$resource","OrderCloudSDK"],angular.module("bachmans-common").factory("bachAssignments",bachAssignments),bachBuyerXpService.$inject=["$q","$http","$interval","nodeapiurl"],angular.module("bachmans-common").factory("bachBuyerXp",bachBuyerXpService),bachGiftCards.$inject=["nodeapiurl","$resource","toastr","$http","OrderCloudSDK"],angular.module("bachmans-common").factory("bachGiftCards",bachGiftCards),bachShipmentsService.$inject=["$q","buyerid","OrderCloudSDK","bachWiredOrders","bachBuyerXp","$resource","nodeapiurl","appname"],angular.module("bachmans-common").factory("bachShipments",bachShipmentsService),bachWiredOrdersService.$inject=["$q"],angular.module("bachmans-common").factory("bachWiredOrders",bachWiredOrdersService);