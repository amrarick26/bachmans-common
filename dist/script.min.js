function bachAssignments(e,t,r){function n(n){return t(e+"/assignments/usergroup",{},{call:{method:"POST",headers:{"oc-token":r.GetToken()}}}).call(n).$promise}var i={UserGroup:n};return i}function bachBuyerXpService(e,t,r,n){function i(n){function i(){var e=r(function(){c&&(r.cancel(e),a.resolve(c))},100)}var a=e.defer();return c?a.resolve(c):s?i():(s=!0,t.get(u,{headers:{"oc-token":n}}).then(function(e){c={xp:e.data},a.resolve(c)}).catch(function(e){a.reject(e)})),a.promise}function a(e,r){return t.put(u,r,{headers:{"oc-token":e}})}function o(e,r){return t.patch(u,e,{headers:{"oc-token":r}})}var u=n+"/buyerxp",c=null,s=!1,d={Get:i,Update:a,Patch:o};return d}function bachGiftCards(e,t,r,n,i){function a(e){return d().create(e).$promise}function o(e){return e.body||e.body.id?d().update({id:e.body.id},e.body).$promise:r.error("id is a required parameter")}function u(e){return d().delete({id:e.id}).$promise}function c(e){return d().list(e&&e.searchTerm?{searchTerm:e.searchTerm}:null).$promise.then(function(e){return e.list})}function s(t){return n.post(e+"/giftcards/purchase/"+t.orderid,{},{headers:{"oc-token":i.GetToken()}})}function d(){var r={create:{method:"POST"},update:{method:"PUT"},"delete":{method:"DELETE"},list:{method:"GET"}};return _.each(r,function(e){e.headers={"oc-token":i.GetToken()}}),t(e+"/giftcards/:id",{},r)}var p={Create:a,Update:o,Delete:u,List:c,Purchase:s};return p}function bachShipmentsService(e,t,r){function n(e){var t=_.groupBy(e,function(e){var t="",r="";e.ShippingAddress&&(t=(e.ShippingAddress.FirstName+e.ShippingAddress.LastName).replace(/ /g,"").toLowerCase(),r=_.values(_.pick(e.ShippingAddress,"Street1","Street2","City","State","Zip","Country")).join("").replace(/ /g,"").toLowerCase());var n=e.xp.DeliveryDate||"",i=e.xp.DeliveryMethod||"";e.xp.Status&&e.xp.Status.indexOf("FTD")>-1&&(e.xp.Status="FTD"),e.xp.Status&&e.xp.Status.indexOf("TFE")>-1&&(e.xp.Status="TFE");var a=e.xp.Status||"Open";return t+r+n+i+a});return i(_.values(t))}function i(e){var t=[];return _.each(e,function(e){var r=_.filter(e,function(e){return _.some(e.xp,{DeliveryMethod:"InStorePickup"})}),n=_.groupBy(e,function(e){return r?e.xp.ProductFromStore:void 0});_.each(n,function(e){t.push(e)})}),a(t)}function a(e){return _.each(e,function(t,r){_.each(t,function(n,i){if(n.Product.xp.isEvent&&t.length>1){var a=t[r].splice(i,1);e.push(a)}})}),o(e)}function o(e){return _.each(e,function(e){e.Cost=0,e.Tax=0,_.each(e,function(t){t&&t.xp&&(t.xp.Tax=t.xp.Tax||0,e.Cost=(100*e.Cost+100*t.LineTotal)/100,e.Tax=(100*e.Tax+100*t.xp.Tax)/100)}),e.Total=(100*e.Cost+e.Tax)/100}),e}function u(i,a,o){var u=n(i),p=[];return _.each(u,function(n,i){var u=[];_.each(n,function(e){u.push({OrderID:a.ID,LineItemID:e.ID,QuantityShipped:e.Quantity})});var h=i+1,f=n[0],l={BuyerID:t,ID:a.ID+"-"+(10>h?"0":"")+h,DateDelivered:null,Cost:n.Cost,Items:u,xp:{Status:c(f),PrintStatus:d(f),Direction:"Outgoing",DeliveryMethod:f.xp.DeliveryMethod,RequestedDeliveryDate:s(f.xp.DeliveryDate),addressType:f.xp.addressType,RecipientName:f.ShippingAddress.FirstName+" "+f.ShippingAddress.LastName,Tax:n.Tax,RouteCode:f.xp.RouteCode,TimePreference:f.xp.deliveryRun||"NO PREF",ShipTo:f.ShippingAddress}};o?p.push(function(){return r.AsAdmin().Shipments.Create(l).then(function(t){var n=[];return _.each(l.Items,function(e){t.Items=[],t.Items.push(e),n.push(r.AsAdmin().Shipments.SaveItem(t.ID,e))}),e.all(n).then(function(){return t})})}()):p.push(r.Shipments.Create(l))}),e.all(p)}function c(e){return e.xp.DeliveryMethod&&(e.xp.DeliveryMethod.indexOf("FTD")>-1||e.xp.DeliveryMethod.indexOf("TFE")>-1)?"OnHold":e.xp.Status&&"OnHold"===e.xp.Status?"OnHold":e.xp.addressType&&["Funeral","Church","Cemetary"].indexOf(e.xp.addressType)>-1?"OnHold":"New"}function s(e){if(e){var t=new Date(e);return t.getFullYear()+"/"+t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1+"/"+(t.getDate()<10?"0"+t.getDate():t.getDate())}return"N/A"}function d(e){return"LocalDelivery"===e.xp.DeliveryMethod||"InStorePickup"===e.xp.DeliveryMethod&&"OtherStore"===e.xp.ProductFromStore?"NotPrinted":"NotNeeded"}function p(t){var n={},i={pageSize:100,orderID:t};return r.Shipments.List(i).then(function(t){var i=[];return _.each(t.Items,function(e){i.push(function(){return r.Shipments.ListItems(e.ID).then(function(t){return e.Items=t.Items,_.each(t.Items,function(e){n[e.LineItemID]=e}),e})}())}),e.all(i).then(function(e){return _.each(e,function(t,r){_.each(t.Items,function(t,i){_.each(t.xp.AddExtraLineItemsList,function(t,a){e[r].Items[i].xp.AddExtraLineItemsList[a]=n[t]})})}),e})})}var h={Group:n,Create:u,List:p};return h}function bachWiredOrdersService(e){function t(e,t){var o=_.groupBy(e,function(e){return e.xp.Destination});if(o.E&&o.E.length>0){var u=_.findWhere(t.wireOrder.OutgoingOrders,{Name:"FTD.com"}),c=_.findWhere(t.wireOrder.OutgoingOrders,{Name:"Teleflora.com"});u.type="FTD",c.type="TFE";var s,d=_.without(_.keys(o),"E");if(0===d.length)return s=r(u.OrderPercentage,c.OrderPercentage),n(e,s);if(1===d.length)return s=d[0],n(e,s);var p=u.OrderPercentage>c.OrderPercentage?u:c,h="FTD"===p.type?c:u,f=i(o.E),l=i(o[p.type]),m=i(o[h.type]);return f+l>=p.MinOrderPrice.Price?a(o.E,l,p).then(function(e){var t=i(e);return t+m>=h.MinOrderPrice.Price?a(e,m,h).then(function(e){_.each(e,function(e){return s=r(u.OrderPercentage,c.OrderPercentage),n([e],s)})}):(s=p.type,n(e,s))}):f+m>=h.MinOrderPrice.Price?(s=h.type,n(o.E,h.type)):(s=p.type,n(o.E,p.type))}}function r(e,t){var r,n=100*Math.random();return r=e&&t?t>e?n>=0&&e>=n?"FTD":"TFE":n>=0&&t>=n?"TFE":"FTD":!e&&t?"TFE":!t&&e?"FTD":n>50?"FTD":"TFE"}function n(e,t){_.each(e,function(e){e.xp.Destination=t})}function i(e){var t=_.pluck(e,"LineTotal");return _.reduce(t,function(e,t){return e+t},0)}function a(t,r,i){if(r>=i.MinOrderPrice.Price)return e.when(t);var o=t.shift();return r+=o,n([o],i.type),a(t,r,i.MinOrderPrice.Price)}var o={DetermineEithers:t};return o}function OrderCloudSDKBuyerXP(e){e.decorator("OrderCloudSDK",["$delegate","bachBuyerXp","$q",function(e,t,r){return e.Buyers.Get=function(){var r=e.GetToken();return t.Get(r)},e.Buyers.List=function(){return e.Buyers.Get().then(function(e){return{Items:[e],Meta:{Page:1,PageSize:1,TotalPages:1,TotalCount:1,ItemRange:[1,1]}}})},e.Buyers.Update=function(){var n=[].slice.call(arguments)[1],i=e.GetToken();return n&&n.xp?t.Update(i,n.xp):r.reject("Missing body")},e.Buyers.Patch=function(){var n=[].slice.call(arguments)[1],i=e.GetToken();return n?t.Patch(i,n):r.reject("Missing body")},e}])}angular.module("bachmans-common",[]),bachAssignments.$inject=["nodeapiurl","$resource","OrderCloudSDK"],angular.module("bachmans-common").factory("bachAssignments",bachAssignments),bachBuyerXpService.$inject=["$q","$http","$interval","nodeapiurl"],angular.module("bachmans-common").factory("bachBuyerXp",bachBuyerXpService),bachGiftCards.$inject=["nodeapiurl","$resource","toastr","$http","OrderCloudSDK"],angular.module("bachmans-common").factory("bachGiftCards",bachGiftCards),bachShipmentsService.$inject=["$q","buyerid","OrderCloudSDK"],angular.module("bachmans-common").factory("bachShipments",bachShipmentsService),bachWiredOrdersService.$inject=["$q"],angular.module("bachmans-common").factory("bachWiredOrders",bachWiredOrdersService),OrderCloudSDKBuyerXP.$inject=["$provide"],angular.module("bachmans-common").config(OrderCloudSDKBuyerXP);